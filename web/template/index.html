<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
        <link rel="stylesheet" href="/style.css"/>
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
        <script src="https://d3js.org/d3.v3.min.js" type="text/javascript"></script>
        <title>Mainflux Deployments</title>
    </head>
    <body>
        <div class="container">
            <div class="sidebar">
                <h2>Mainflux Deployment Summary</h2>
                <p>Mainflux currently has {{.NoDeployments}} deployments in {{.NoCountries}} countries.</p>
                <p>List of countries:</p>
                <ul>
                    {{range .Countries}}
                        <li>{{.}}</li>
                    {{end}}
                </ul>
            </div>
            <div class="main-content">
                <div id="map"></div>
            </div>
        </div>
        <script type="text/javascript">
            //create map object and set default positions and zoom level
            var map = L.map('map').setView([20, 0], 2);
            L.tileLayer('https://{s}.tile.osm.org/{z}/{x}/{y}.png', {attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}).addTo(map);
            function logJSONData() {
                var mapData = `{{.MapData}}`;
                const obj = JSON.parse(mapData)
                console.log(obj.Telemetry);
                obj.Telemetry.forEach(tel => {
                    L.marker([tel.latitude, tel.longitude]).bindPopup(
                        `<h3>Deployment details</h3>
                        <p>IP Address:\t${tel.ip_address}</p>
                        <p>version:\t${tel.mainflux_version}</p>
                        <p>last seen:\t${tel.last_seen}</p>
                        <p>country:\t${tel.country}</p>
                        <p>city:\t${tel.city}</p>
                        <p>Services:\t${tel.services.join(', ')}</p>`
                    ).addTo(map);
                });
            }
            logJSONData();
        </script>
    </body>
</html>